<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Desactivar cacheo del PDF estándar para que siempre re-renderice el template -->
    <record id="account.account_invoices" model="ir.actions.report">
        <field name="attachment_use">False</field>
        <field name="attachment" eval="False"/>
        <field name="print_report_name">'%s' % (object.name)</field>
    </record>

    <record id="account.account_invoices_without_payment" model="ir.actions.report">
        <field name="attachment_use">False</field>
        <field name="attachment" eval="False"/>
        <field name="print_report_name">'%s' % (object.name)</field>
    </record>

    <!-- Configurar nombre del PDF para recibos de pago (complementos de pago) -->
    <record id="account.action_report_payment_receipt" model="ir.actions.report">
        <field name="print_report_name">'%s' % (object.name)</field>
    </record>

    <!-- Acción de reporte para Facturas Samper -->
    <record id="report_invoice_sam" model="ir.actions.report">
        <field name="name">Facturas Samper</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">account.report_invoice</field>
        <field name="report_file">account.report_invoice</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="print_report_name">'%s' % (object.name)</field>
    </record>

    <!-- Template personalizado para facturas Samper -->
    <template id="report_invoice_document_inherit_samper" inherit_id="account.report_invoice_document" priority="99">

        <!-- Agregar estilos CSS personalizados -->
        <xpath expr="//div[@class='clearfix invoice_main']" position="before">
            <style>
                .samper-customer-box {
                    background-color: #f9f9f9;
                    padding: 15px;
                    border: 1px solid #ddd;
                    margin-bottom: 15px;
                }
                .samper-info-text {
                    font-size: 15px;
                    line-height: 1.5;
                }
                .samper-uuid-line {
                    font-size: 18px;
                }
                .samper-nombrecomercial-line {
                    font-size: 20px;
                }
                .table-samper th {
                    background-color: #e0e0e0;
                    border: 1px solid #666;
                    font-size: 11px;
                }
                .table-samper td {
                    border: 1px solid #666666ff;
                    font-size: 11px;
                }
                /* Resaltar sección de dirección de entrega */
                div[name='shipping_address_block'] {
                    background-color: #e8e8e8;
                    padding: 10px;
                    border-radius: 4px;
                }
                div[name='shipping_address_block'] strong,
                div[name='shipping_address_block'] div {
                    font-weight: bold;
                }
                /* Ocultar plazo de pago */
                div#payment_term {
                    display: none !important;
                }
            </style>
            <!-- Ocultar columna duplicada de Código del producto de l10n_mx_edi (4ta columna) solo cuando está timbrada -->
            <t t-if="o.state == 'posted'">
                <style>
                    .table-samper th:nth-child(4),
                    .table-samper td:nth-child(4) {
                        display: none !important;
                    }
                </style>
            </t>
        </xpath>

        <!-- Agregar información adicional del cliente después de la dirección -->
        <xpath expr="//div[@class='row']" position="after">
            <div class="samper-customer-box">
                <div class="row samper-info-text">
                    <div class="col-12">
                    <span class="samper-uuid-line"><strong>UUID:</strong> <span t-field="o.l10n_mx_edi_cfdi_uuid"/></span><br/>
                    <span class="samper-nombrecomercial-line"> <span t-field="o.partner_id.x_nombre_comercial"/></span><br/>
                        <strong>RUTA:</strong> <span t-field="o.partner_shipping_id.x_ruta"/><br/>
                        <strong>FECHA:</strong> <span t-field="o.create_date" t-options='{"widget": "datetime", "format": "dd/MM/yyyy HH:mm:ss"}'/>
                    </div>
                </div>
            </div>
        </xpath>

        <!-- Ocultar la dirección original -->
        <xpath expr="//div[@class='row']" position="attributes">
            <attribute name="style">display: none;</attribute>
        </xpath>

        <!-- Aplicar estilos a la tabla -->
        <xpath expr="//table[@name='invoice_line_table']" position="attributes">
            <attribute name="class">table-samper table table-sm</attribute>
        </xpath>

        <!-- Agregar columna Código del producto al inicio de la tabla -->
        <xpath expr="//th[@name='th_description']" position="before">
            <th name="th_codigo_producto" class="text-start">Código del producto</th>
        </xpath>

        <xpath expr="//td[@name='account_invoice_line_name']" position="before">
            <td name="td_codigo_producto">
                <span t-field="line.product_id.unspsc_code_id.code"/>
            </td>
        </xpath>

        <!-- Cambiar título de Description a "Descripción" -->
        <xpath expr="//th[@name='th_description']/span" position="replace">
            <span>Descripción</span>
        </xpath>

        <!-- Agregar columna de Lotes después de Description -->
        <xpath expr="//th[@name='th_description']" position="after">
            <th name="th_lots" class="text-start">Lotes</th>
        </xpath>

        <xpath expr="//td[@name='account_invoice_line_name']" position="after">
            <td name="td_lots">
                <span t-if="line.x_lotes" t-field="line.x_lotes"/>
            </td>
        </xpath>

        <!-- Agregar columna de Piezas después de Quantity -->
        <xpath expr="//th[@name='th_quantity']" position="after">
            <th name="th_piezas" class="text-end">Piezas</th>
        </xpath>

        <xpath expr="//td[@name='td_quantity']" position="after">
            <td name="td_piezas" class="text-end">
                <span t-if="line.x_piezas" t-field="line.x_piezas"/>
            </td>
        </xpath>

        <!-- Ocultar la sección de totales en medio (antes del div total final) -->
        <xpath expr="//div[@id='total']" position="before">
            <style>
                /* Ocultar tabla resumen de productos si existe */
                .o_report_layout_standard table:not([name='invoice_line_table']):not(.o_total_table) {
                    display: none !important;
                }
            </style>
        </xpath>

        <!-- Términos y condiciones a la extrema izquierda, flotando junto a los totales -->
        <xpath expr="//div[@id='total']" position="before">
            <div style="float: left; width: 45%; font-size: 11px; line-height: 1.4; color: #000000; font-weight: bold;">
                <t t-if="o.narration">
                    <strong>Términos y condiciones:</strong>
                    <div t-field="o.narration"/>
                </t>
            </div>
        </xpath>

        <!-- Ocultar Fecha límite original (due_date) -->
        <xpath expr="//div[@name='due_date']" position="attributes">
            <attribute name="t-if">False</attribute>
        </xpath>

        <!-- Reemplazar Delivery Date por Fecha de Vencimiento -->
        <xpath expr="//div[@name='delivery_date']" position="replace">
            <div class="col" t-if="o.invoice_date_due" name="delivery_date">
                <strong>Fecha de Vencimiento</strong>
                <div t-field="o.invoice_date_due"/>
            </div>
        </xpath>

    </template>
</odoo>
